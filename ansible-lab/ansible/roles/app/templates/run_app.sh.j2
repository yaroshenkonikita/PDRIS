#!/usr/bin/env bash
set -euo pipefail

APP_ROOT="{{ app_root }}"
LOG_DIR="/var/log/{{ app_name }}"
RUN_DIR="/var/run"
PID_FILE="$RUN_DIR/{{ app_name }}.pid"

mkdir -p "$LOG_DIR" "$RUN_DIR"

if [[ -f "$PID_FILE" ]] && ps -p "$(cat "$PID_FILE")" >/dev/null 2>&1; then
  echo "{{ app_name }} already running with PID $(cat "$PID_FILE")"
  exit 0
fi

export DATABASE_URL="{{ database_url }}"

cd "$APP_ROOT"

# shellcheck disable=SC2086
nohup "$APP_ROOT/venv/bin/uvicorn" app.main:app \
  --host 0.0.0.0 --port {{ app_port }} --workers 2 \
  > "$LOG_DIR/app.log" 2>&1 & echo $! > "$PID_FILE"

echo "Started {{ app_name }} with PID $(cat "$PID_FILE")"

